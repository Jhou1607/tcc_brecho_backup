<app-header></app-header>
<div class="montador-look-container">
  <div class="title-banner">
    <h1>Montar Look</h1>
  </div>
  <div class="montador-box">

  <nz-modal [(nzVisible)]="showErroDownImg"
            nzTitle="Erro ao baixar imagem"
            [nzFooter]="null"
            [nzWidth]="'600px'"
            [nzClosable]= "true"
            [nzMaskClosable]="true"
            (nzOnCancel) = "closeInfoDownImg()"
  >
    <ng-container *nzModalContent>
      <p>
        Não foi possível baixar a imagem do link fornecido, provavelmente por restrições do site que a hospeda.
      </p>
      <p>
        Tente o 1º método, de carregar uma imagem local, e no campo "Nome" da janela de seleção de arquivo cole o link da imagem e clique em "Abrir"
      </p>
      <img src="assets/images/open_img.png" style="width: 100%;">
    </ng-container>

  </nz-modal>


  <nz-modal [(nzVisible)]="showAddImg"
            [nzTitle]="'Adicionar ' + currentGroup?.name"
            [nzFooter]="null"
            [nzClosable]= "true"
            [nzMaskClosable]="true"
            (nzOnCancel) = "cancelAddImg()"
  >
    <ng-container *nzModalContent>

      <nz-steps [nzCurrent]="currentStep">
        <nz-step nzTitle="Carregar imagem"></nz-step>
        <nz-step nzTitle="Ajustar imagem"></nz-step>
      </nz-steps>

      <div class="steps-content" *ngIf="currentStep == 0">
        <div  *ngIf="loadingImg" class="dv-processing-img">
          <div class="proccess-image" style="margin: auto">
            <nz-spin nzTip="aguarde...">
            </nz-spin>
          </div>
        </div>
        <div style="text-align: center">

          <nz-upload
            nzType="drag"
            [nzMultiple]="false"
            [(nzFileList)]="fileList"
            [nzLimit]="1"
            [nzSize]="2048"
            [nzCustomRequest]="handleUploadRequest"
            [nzAccept]="'image/png, image/jpeg'"
            [nzFileListRender]="emptyFileListRenderTemplate"
            nzAction="#"
            [nzBeforeUpload]="beforeUploadImgLocal"
            (nzChange)="imgLocalLoaded($event)"
          >
            <ng-template #emptyFileListRenderTemplate></ng-template>
            <p class="ant-upload-drag-icon">
              <nz-icon nzType="inbox" />
            </p>
            <p class="ant-upload-text">Clique aqui ou arraste uma imagem para carregá-la </p>
          </nz-upload>
          <br>
          <p>ou</p>
          <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" [nzPrefix]="prefixLink">
            <input type="text" nz-input placeholder="Carregue a imagem de uma Url" [(ngModel)]="imgFromUrl" />
          </nz-input-group>
          <ng-template #suffixIconButton>
            <button nz-button  nzSearch (click)="loadImgFromUrl()" [disabled]="!isValidUrl(imgFromUrl)" >
              <nz-icon nzType="cloud-download" /></button>
          </ng-template>
          <ng-template #prefixLink><nz-icon nzType="link" /></ng-template>

        </div>

      </div>

      <div class="steps-content" *ngIf="lastCroppedBlob && currentStep == 1">
        <div class="cropper-wrapper">
          <div style="color: #243164;  width: 100%; text-align: center;">recorte a imagem removendo espaços desnecessários</div>
          <image-cropper
            #imageCropperRef
            [imageChangedEvent]="imageChangedEvent"
            [imageURL]="previewUrl"
            [onlyScaleDown]="true"
            [maintainAspectRatio]="false"
            output="blob"
            format="png"
            (imageCropped)="imageCropped($event)"
            (imageLoaded)="imageLoaded($event)"
            (cropperReady)="cropperReady()"
            (loadImageFailed)="loadImageFailed()"
          ></image-cropper>
        </div>
      </div>

      <div class="steps-action">

        @if (currentStep == 1) {
          <button nz-button nzType="default" (click)="preStep()">
            <span>Voltar</span>
          </button>
          <button nz-button nzType="default" (click)="saveAddImg()">
            <span>Finalizar</span>
          </button>
        }

      </div>

    </ng-container>
  </nz-modal>



    <div class="main-layout">


    <div class="canvas-column">
      <div class="btn-wrapper show-mobile" nz-flex [nzGap]="'middle'" nzWrap="wrap" nzJustify="space-evenly" style="margin-bottom: 10px; gap: 3px">
        <button *ngFor="let group of clothingGroups"  style="width: 50px; height: 50px; padding: 0" nz-button >
          <img [src]="group.icon" style="width: 40px" />
        </button>
      </div>
      <div class="canvas-container">
        <canvas #canvas></canvas>
      </div>
      <div class="action-buttons">
        <button class="baixar-look-btn" (click)="exportLookAsPng()">
          <i class="fas fa-download"></i>
          Baixar Look
        </button>
        <button class="salvar-look-btn" (click)="saveLook()">
          <i class="fas fa-save"></i>
          Salvar Look
        </button>
        <button class="ai-look-btn" (click)="openAiLookModal()" [disabled]="loadingAiLook">
          <fa-icon [icon]="faMagic"></fa-icon>
          Look com IA (Beta)
        </button>
      </div>
    </div>
    <div class="groups-column hidden-mobile">
      <nz-collapse [nzAccordion]="true">
        <nz-collapse-panel *ngFor="let group of clothingGroups" [nzHeader]="group.name">
          <div class="items">
            <div class="add-item" title="Carregar item" (click)="addItem(group)"><nz-icon nzType="plus"></nz-icon> </div>
            <div class="proccess-image" *ngIf="loadingImg" >
              <nz-spin nzTip="aguarde...">
              </nz-spin>
            </div>
            <div *ngFor="let item of group.items" class="item">
              <div class="image-container">
                <img [src]="item.canvasUrl" [alt]="item.name" [title]="item.name" class="item-image" (click)="selectClothingItem(group, item)" />
                <button *ngIf="item.origem === 'catalog'" class="heart-btn" (click)="onToggleFavorite(item, group)" title="Remover dos favoritos">
                  <fa-icon [icon]="faSolidHeart" style="color: #e74c3c;"></fa-icon>
                </button>
              </div>

            </div>
          </div>
        </nz-collapse-panel>
      </nz-collapse>
      <ng-template #characterIcon><nz-icon  nzType="heart" nzTheme="fill" ></nz-icon></ng-template>
    </div>
  </div>
</div>

<!-- Modal para nomear o look -->
<div class="modal-overlay" *ngIf="showNomeLookModal" (click)="cancelarNomeLook()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Nomear Look</h3>
    <input 
      type="text" 
      [(ngModel)]="nomeLook" 
      placeholder="Digite o nome do look (opcional)"
      class="nome-look-input"
      (keyup.enter)="confirmarNomeLook()"
    />
    <div class="modal-buttons">
      <button class="btn-cancelar" (click)="cancelarNomeLook()">Cancelar</button>
      <button class="btn-confirmar" (click)="confirmarNomeLook()">Salvar</button>
    </div>
  </div>
</div>

<!-- Modal para exibir o Look com IA -->
<nz-modal [(nzVisible)]="showAiLookModal"
          nzTitle="Look com IA (Beta)"
          [nzFooter]="null"
          [nzClosable]="true"
          [nzMaskClosable]="true"
          (nzOnCancel)="closeAiLookModal()"
          [nzWidth]="'auto'"
          [nzCentered]="true"
          [nzBodyStyle]="{ height: 'calc(100vh - 80px)', overflow: 'auto', padding: '0' }">
  <ng-container *nzModalContent>
    <!-- Barra superior com controles -->
    <div class="ai-look-controls">
      <div class="control-group">
        <div class="gender-selector">
          <div class="gender-icon woman-icon" 
               [class.selected]="aiLookGender === 'woman'"
               (click)="selectGender('woman')"
               title="Mulher">
          </div>
          <div class="gender-icon man-icon" 
               [class.selected]="aiLookGender === 'man'"
               (click)="selectGender('man')"
               title="Homem">
          </div>
        </div>
      </div>
      
      <div class="control-group">
        <span class="label">Pele</span>
        <div class="color-palette">
          <div class="color-swatch" 
               [class.selected]="aiLookSkinColor === 'WHITE'"
               (click)="selectSkinColor('WHITE')"
               style="background-color: #f1e5dd"></div>
          <div class="color-swatch" 
               [class.selected]="aiLookSkinColor === 'ASIAN'"
               (click)="selectSkinColor('ASIAN')"
               style="background-color: #d7cba5"></div>
          <div class="color-swatch" 
               [class.selected]="aiLookSkinColor === 'LATIN'"
               (click)="selectSkinColor('LATIN')"
               style="background-color: #8d6552"></div>
          <div class="color-swatch" 
               [class.selected]="aiLookSkinColor === 'BLACK'"
               (click)="selectSkinColor('BLACK')"
               style="background-color: #492c22"></div>
        </div>
      </div>

      <div class="control-group">
        <span class="label">Medidas</span>
        <div class="input-group">
          <input type="number" 
                 [(ngModel)]="aiLookWeight" 
                 (ngModelChange)="selectWeight($event)"
                 placeholder="Kg"
                 min="40" max="350">
          <input type="number" 
                 [(ngModel)]="aiLookHeight" 
                 (ngModelChange)="selectHeight($event)"
                 placeholder="Cm"
                 min="60" max="250">
        </div>
      </div>

      <div class="control-actions">
        <button nz-button nzType="primary" (click)="generateFromBar()" [disabled]="loadingAiLook || !aiLookGender || !aiLookSkinColor || !aiLookHeight || !aiLookWeight">
          <nz-icon nzType="sync" [class.spinning]="loadingAiLook"></nz-icon>
          Gerar
        </button>
        <button nz-button nzType="default" (click)="requestAiComment()" [disabled]="!aiLookImage || loadingComment" title="Comentário da IA">
          <nz-icon nzType="message" [class.spinning]="loadingComment"></nz-icon>
        </button>
        <button nz-button nzType="default" (click)="shareHelp()" [disabled]="!aiLookImage" title="Compartilhar">
          <nz-icon nzType="share-alt"></nz-icon>
        </button>
      </div>
    </div>

    <!-- Conteúdo da modal -->
    <div class="ai-look-container" *ngIf="aiLookImage || loadingAiLook">
      <!-- Placeholder fixo enquanto gera, some quando a imagem chega -->
      <div class="ai-look-placeholder" *ngIf="!aiLookImage && loadingAiLook">
        <nz-spin></nz-spin>
      </div>

      <!-- Imagem com overlay de carregamento -->
      <div class="ai-look-image-wrapper" *ngIf="aiLookImage" [class.loading]="loadingAiLook">
        <img [src]="aiLookImage" alt="Look com IA" class="ai-look-image" />
      </div>
    </div>

    <!-- Texto inicial quando não há imagem -->
    <div class="ai-look-initial" *ngIf="!aiLookImage && !loadingAiLook">
      <p>Selecione os parâmetros para gerar o look</p>
    </div>
  </ng-container>
</nz-modal>

<!-- Modal para exibir o comentário da IA -->
<nz-modal [(nzVisible)]="showCommentModal"
          nzTitle="Comentário da IA sobre o Look"
          [nzFooter]="null"
          [nzClosable]="true"
          [nzMaskClosable]="true"
          (nzOnCancel)="closeCommentModal()"
          [nzWidth]="'800px'"
          [nzCentered]="true"
          [nzBodyStyle]="{ maxHeight: 'calc(100vh - 120px)', overflow: 'auto', padding: '0' }">
  <ng-container *nzModalContent>
    <div class="ai-comment-container">
      <div class="ai-comment-content">
        <p [innerHTML]="aiComment"></p>
      </div>
    </div>
  </ng-container>
</nz-modal>
