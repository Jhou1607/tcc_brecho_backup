<nz-modal
  [(nzVisible)]="isModalVisible"
  [nzTitle]="title"
  [nzFooter]="null"
  [nzClosable]="true"
  [nzMaskClosable]="true"
  (nzOnCancel)="closeModal()"
  [nzWidth]="'800px'">
  
  <ng-container *nzModalContent>
    <!-- Steps -->
    <nz-steps [nzCurrent]="currentStep" style="margin-bottom: 24px;">
      <nz-step nzTitle="Carregar imagem"></nz-step>
      <nz-step nzTitle="Remover fundo"></nz-step>
      <nz-step nzTitle="Recortar imagem"></nz-step>
    </nz-steps>

    <!-- Step 0: Image Upload -->
    <div *ngIf="currentStep === 0" class="upload-step">
      <!-- Processing overlay -->
      <div *ngIf="isProcessing" class="processing-overlay">
        <div class="processing-content">
          <nz-spin [nzTip]="processingMessage" [nzSize]="'large'">
          </nz-spin>
        </div>
      </div>

      <div class="upload-content">
        <!-- Image Preview (if image is loaded) -->
        <div *ngIf="previewUrl && selectedFile" class="uploaded-image-preview">
          <div class="preview-header">
            <nz-icon nzType="check-circle" nzTheme="twotone" nzTwotoneColor="#52c41a"></nz-icon>
            <span>Imagem carregada com sucesso!</span>
          </div>
          <div class="preview-image">
            <img [src]="previewUrl" alt="Preview da imagem" />
          </div>
          <div class="preview-info">
            <p><strong>Nome:</strong> {{ selectedFile.name }}</p>
            <p><strong>Tamanho:</strong> {{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB</p>
            <p><strong>Tipo:</strong> {{ selectedFile.type }}</p>
          </div>
        </div>

        <!-- Upload Area (if no image loaded) -->
        <div *ngIf="!selectedFile" class="upload-area">
          <!-- Drag & Drop Upload -->
          <nz-upload
            nzType="drag"
            [nzMultiple]="false"
            [(nzFileList)]="fileList"
            [nzLimit]="1"
            [nzSize]="maxFileSize * 1024"
            [nzCustomRequest]="handleUploadRequest"
            [nzAccept]="acceptedTypes.join(',')"
            [nzFileListRender]="emptyFileListRenderTemplate"
            nzAction="#"
            [nzBeforeUpload]="beforeUpload"
            (nzChange)="handleRemove($event)">
            <ng-template #emptyFileListRenderTemplate></ng-template>
            <p class="ant-upload-drag-icon">
              <nz-icon nzType="inbox" />
            </p>
            <p class="ant-upload-text">Clique aqui ou arraste uma imagem para carregá-la</p>
            <p class="ant-upload-hint">
              Formatos aceitos: {{ acceptedTypes.join(', ') }} | Máximo: {{ maxFileSize }}MB
            </p>
          </nz-upload>

          <!-- URL Input (optional) -->
          <div *ngIf="showUrlInput" class="url-input-section">
            <div class="divider">
              <span>ou</span>
            </div>
            
            <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" [nzPrefix]="prefixLink">
              <input 
                type="text" 
                nz-input 
                placeholder="Cole uma URL de imagem aqui" 
                [(ngModel)]="imageFromUrl" />
            </nz-input-group>
            
            <ng-template #suffixIconButton>
              <button 
                nz-button 
                nzSearch 
                (click)="loadImageFromUrl()" 
                [disabled]="!imageFromUrl || isProcessing">
                <nz-icon nzType="cloud-download" />
              </button>
            </ng-template>
            
            <ng-template #prefixLink>
              <nz-icon nzType="link" />
            </ng-template>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 0.5: Background Removal -->
    <div *ngIf="currentStep === 0.5" class="background-removal-step">
      <div class="image-preview" *ngIf="previewUrl">
        <img [src]="previewUrl" alt="Preview da imagem" />
      </div>
      
      <div class="processing-status" *ngIf="isProcessing">
        <nz-spin nzSize="large"></nz-spin>
        <p>{{ processingMessage }}</p>
      </div>
      
      <div class="step-actions" *ngIf="!isProcessing">
        <button 
          nz-button 
          nzType="primary" 
          (click)="nextStep()"
          class="action-button">
          Remover Fundo
        </button>
        <button 
          nz-button 
          nzType="default" 
          (click)="skipBackgroundRemoval()"
          class="action-button skip-button">
          Pular Remoção de Fundo
        </button>
      </div>
    </div>

    <!-- Step 1: Image Cropping -->
    <div *ngIf="currentStep === 1" class="cropping-step">
      <div class="cropper-wrapper">
        <div class="cropper-instructions">
          <nz-icon nzType="scissor" style="margin-right: 8px;"></nz-icon>
          Recorte a imagem removendo espaços desnecessários
        </div>
        
        <image-cropper
          #imageCropperRef
          [imageChangedEvent]="imageChangedEvent"
          [imageURL]="objectUrl || undefined"
          [onlyScaleDown]="true"
          [maintainAspectRatio]="false"
          output="blob"
          format="png"
          (imageCropped)="imageCropped($event)"
          (imageLoaded)="imageLoaded($event)"
          (cropperReady)="cropperReady()"
          (loadImageFailed)="loadImageFailed()">
        </image-cropper>
      </div>
    </div>

    <!-- Step Actions -->
    <div class="step-actions">
      <button 
        *ngIf="currentStep === 0.5 || currentStep === 1" 
        nz-button 
        nzType="default" 
        (click)="previousStep()"
        style="margin-right: 8px;">
        <span>Voltar</span>
      </button>
      
      <button 
        *ngIf="currentStep === 0" 
        nz-button 
        nzType="primary" 
        (click)="nextStep()"
        [disabled]="!selectedFile">
        <span>Continuar</span>
      </button>
      
      <button 
        *ngIf="currentStep === 1" 
        nz-button 
        nzType="primary" 
        (click)="finalizeProcessing()"
        [disabled]="!lastCroppedBlob">
        <span>Finalizar</span>
      </button>
    </div>
  </ng-container>
</nz-modal>
