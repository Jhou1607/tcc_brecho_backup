<nz-modal
  [(nzVisible)]="isModalVisible"
  [nzTitle]="title"
  [nzFooter]="null"
  [nzClosable]="true"
  [nzMaskClosable]="true"
  (nzOnCancel)="closeModal()"
  [nzWidth]="'1000px'">
  
  <ng-container *nzModalContent>
    <!-- Steps -->
    <nz-steps [nzCurrent]="currentStep" style="margin-bottom: 32px;">
      <nz-step nzTitle="Carregar imagem"></nz-step>
      <nz-step nzTitle="Processar imagem"></nz-step>
      <nz-step nzTitle="Recortar imagem"></nz-step>
    </nz-steps>

    <!-- Step 1: Image Upload -->
    <div *ngIf="currentStep === 0" class="upload-step">
      <div class="upload-content">
        <!-- Image Preview (if image is loaded) -->
        <div *ngIf="previewUrl && selectedFile" class="uploaded-image-preview">
          <div class="preview-header">
            <nz-icon nzType="check-circle" nzTheme="twotone" nzTwotoneColor="#52c41a"></nz-icon>
            <span>Imagem carregada com sucesso!</span>
          </div>
          <div class="preview-image">
            <img [src]="previewUrl" alt="Preview da imagem" />
          </div>
          <div class="preview-info">
            <p><strong>Nome:</strong> {{ selectedFile.name }}</p>
            <p><strong>Tamanho:</strong> {{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB</p>
            <p><strong>Tipo:</strong> {{ selectedFile.type }}</p>
            <p><strong>Dimensões:</strong> {{ imageDimensions.width }} x {{ imageDimensions.height }}px</p>
          </div>
        </div>

        <!-- Upload Area (if no image loaded) -->
        <div *ngIf="!selectedFile" class="upload-area">
          <!-- Drag & Drop Upload -->
          <nz-upload
            nzType="drag"
            [nzMultiple]="false"
            [(nzFileList)]="fileList"
            [nzLimit]="1"
            [nzSize]="maxFileSize * 1024"
            [nzCustomRequest]="handleUploadRequest"
            [nzAccept]="acceptedTypes.join(',')"
            [nzFileListRender]="emptyFileListRenderTemplate"
            nzAction="#"
            [nzBeforeUpload]="beforeUpload"
            (nzChange)="handleRemove($event)">
            <ng-template #emptyFileListRenderTemplate></ng-template>
            <p class="ant-upload-drag-icon">
              <nz-icon nzType="inbox" />
            </p>
            <p class="ant-upload-text">Clique aqui ou arraste uma imagem para carregá-la</p>
            <p class="ant-upload-hint">
              Formatos aceitos: {{ acceptedTypes.join(', ') }} | Máximo: {{ maxFileSize }}MB
            </p>
          </nz-upload>

          <!-- URL Input (optional) -->
          <div *ngIf="showUrlInput" class="url-input-section">
            <div class="divider">
              <span>ou</span>
            </div>
            
            <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" [nzPrefix]="prefixLink">
              <input 
                type="text" 
                nz-input 
                placeholder="Cole uma URL de imagem aqui" 
                [(ngModel)]="imageFromUrl" />
            </nz-input-group>
            
            <ng-template #suffixIconButton>
              <button 
                nz-button 
                nzSearch 
                (click)="loadImageFromUrl()" 
                [disabled]="!imageFromUrl || isProcessing">
                <nz-icon nzType="cloud-download" />
              </button>
            </ng-template>
            
            <ng-template #prefixLink>
              <nz-icon nzType="link" />
            </ng-template>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Image Processing (Background Removal) -->
    <div *ngIf="currentStep === 1" class="processing-step">
      <div class="processing-content">
        <!-- Image Preview -->
        <div class="image-preview-section">
          <div class="preview-container">
            <img [src]="previewUrl" alt="Preview da imagem" />
          </div>
        </div>
        
        <!-- Processing Options -->
        <div class="processing-options">
          <div class="options-header">
            <h3>Processar Imagem</h3>
            <p>Escolha como deseja processar sua imagem:</p>
          </div>
          
          <!-- Background Removal -->
          <div class="option-card">
            <div class="option-header">
              <nz-icon nzType="scissor" nzTheme="twotone" nzTwotoneColor="#52c41a"></nz-icon>
              <h4>Remover Fundo</h4>
            </div>
            <p>Remove automaticamente o fundo da imagem usando IA</p>
            
            <div class="option-actions">
              <button 
                nz-button 
                nzType="primary" 
                (click)="removeBackground()"
                [nzLoading]="isProcessing"
                [disabled]="isProcessing"
                class="action-button">
                {{ isProcessing ? 'Processando...' : 'Remover Fundo' }}
              </button>
            </div>
            
            <!-- Processing Status -->
            <div *ngIf="isProcessing" class="processing-status">
              <nz-spin nzSize="small"></nz-spin>
              <span>{{ processingMessage }}</span>
            </div>
          </div>
          
          <!-- Skip Option -->
          <div class="option-card skip-option">
            <div class="option-header">
              <nz-icon nzType="forward" nzTheme="twotone" nzTwotoneColor="#faad14"></nz-icon>
              <h4>Pular Processamento</h4>
            </div>
            <p>Use a imagem original sem modificações</p>
            
            <div class="option-actions">
              <button 
                nz-button 
                nzType="default" 
                (click)="skipProcessing()"
                [disabled]="isProcessing"
                class="action-button skip-button">
                Pular e Continuar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Image Cropping -->
    <div *ngIf="currentStep === 2" class="cropping-step">
      <div class="cropping-content">
        <div class="cropping-header">
          <nz-icon nzType="scissor" nzTheme="twotone" nzTwotoneColor="#52c41a"></nz-icon>
          <h4>Recortar Imagem (Opcional)</h4>
          <p>Recorte a imagem para remover espaços desnecessários ou ajustar o enquadramento</p>
        </div>
        
        <div class="cropper-wrapper">
          <image-cropper
            #imageCropperRef
            [imageChangedEvent]="imageChangedEvent"
            [imageURL]="objectUrl || undefined"
            [onlyScaleDown]="true"
            [maintainAspectRatio]="false"
            output="blob"
            format="png"
            (imageCropped)="imageCropped($event)"
            (imageLoaded)="imageLoaded($event)"
            (cropperReady)="cropperReady()"
            (loadImageFailed)="loadImageFailed()">
          </image-cropper>
        </div>
        
        <div class="cropping-info">
          <p><strong>Dica:</strong> Você pode pular o recorte se estiver satisfeito com a imagem atual</p>
        </div>
      </div>
    </div>

    <!-- Step Actions -->
    <div class="step-actions">
      <button 
        *ngIf="currentStep > 0" 
        nz-button 
        nzType="default" 
        (click)="previousStep()"
        class="action-button back-button">
        <nz-icon nzType="left"></nz-icon>
        <span>Voltar</span>
      </button>
      
      <button 
        *ngIf="currentStep === 0" 
        nz-button 
        nzType="primary" 
        (click)="nextStep()"
        [disabled]="!selectedFile"
        class="action-button continue-button">
        <span>Continuar</span>
        <nz-icon nzType="right"></nz-icon>
      </button>
      
      <button 
        *ngIf="currentStep === 1 && !isProcessing" 
        nz-button 
        nzType="primary" 
        (click)="nextStep()"
        class="action-button continue-button">
        <span>Continuar</span>
        <nz-icon nzType="right"></nz-icon>
      </button>
      
      <button 
        *ngIf="currentStep === 2" 
        nz-button 
        nzType="primary" 
        (click)="finalizeProcessing()"
        class="action-button submit-button">
        Finalizar
      </button>
    </div>
  </ng-container>
</nz-modal>
