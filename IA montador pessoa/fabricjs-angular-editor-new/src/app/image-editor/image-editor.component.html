<div class="editor-container">
  <h2>Montar Look</h2>

  <!-- Modal para Categorias Mobile -->
  <nz-modal [(nzVisible)]="showMobileCategoryModal"
            [nzTitle]="currentMobileGroup?.name"
            [nzFooter]="null"
            [nzClosable]="true"
            [nzMaskClosable]="true"
            (nzOnCancel)="closeMobileCategoryModal()"
            [nzWidth]="'90vw'"
            [nzBodyStyle]="{ maxHeight: '70vh', overflow: 'auto' }">
    <ng-container *nzModalContent>
      <div class="mobile-items-grid">
        <div class="mobile-add-item" title="Carregar item" (click)="addItem(currentMobileGroup!)">
          <nz-icon nzType="plus"></nz-icon>
          <span>Adicionar</span>
        </div>
        <div class="proccess-image" *ngIf="loadingImg">
          <nz-spin nzTip="aguarde..."></nz-spin>
        </div>
        <div *ngFor="let item of currentMobileGroup?.items" 
             class="mobile-item-wrapper">
          <button class="mobile-item" (click)="selectClothingItem(currentMobileGroup!, item)">
            <div class="mobile-image-container">
              <img [src]="item.url" [alt]="item.name" [title]="item.name" class="mobile-item-image" />
              <nz-rate [(ngModel)]="item.favorited" [nzCount]="1" [nzCharacter]="characterIcon" class="mobile-heart-icon"></nz-rate>
            </div>
          </button>
          <p class="mobile-item-name">{{ item.name }}</p>
        </div>
      </div>
    </ng-container>
  </nz-modal>

  <nz-modal [(nzVisible)]="showErroDownImg"
            nzTitle="Erro ao baixar imagem"
            [nzFooter]="null"
            [nzWidth]="'600px'"
            [nzClosable]= "true"
            [nzMaskClosable]="true"
            (nzOnCancel) = "closeInfoDownImg()"
  >
    <ng-container *nzModalContent>
      <p>
        Não foi possível baixar a imagem do link fornecido, provavelmente por restrições do site que a hospeda.
      </p>
      <p>
        Tente o 1º método, de carregar uma imagem local, e no campo "Nome" da janela de seleção de arquivo cole o link da imagem e clique em "Abrir"
      </p>
      <img src="assets/images/open_img.png" style="width: 100%;">
    </ng-container>

  </nz-modal>

  <nz-modal [(nzVisible)]="showAddImg"
            [nzTitle]="'Adicionar ' + currentGroup?.name"
            [nzFooter]="null"
            [nzClosable]= "true"
            [nzMaskClosable]="true"
            (nzOnCancel) = "cancelAddImg()"
  >
    <ng-container *nzModalContent>

      <nz-steps [nzCurrent]="currentStep">
        <nz-step nzTitle="Carregar imagem"></nz-step>
        <nz-step nzTitle="Ajustar imagem"></nz-step>
      </nz-steps>

      <div class="steps-content" *ngIf="currentStep == 0">
        <div  *ngIf="loadingImg" class="dv-processing-img">
          <div class="proccess-image" style="margin: auto">
            <nz-spin nzTip="aguarde...">
            </nz-spin>
          </div>
        </div>
        <div style="text-align: center">

          <nz-upload
            nzType="drag"
            [nzMultiple]="false"
            [(nzFileList)]="fileList"
            [nzLimit]="1"
            [nzSize]="2048"
            [nzCustomRequest]="handleUploadRequest"
            [nzAccept]="'image/png, image/jpeg'"
            [nzFileListRender]="emptyFileListRenderTemplate"
            nzAction="#"
            [nzBeforeUpload]="beforeUploadImgLocal"
            (nzChange)="imgLocalLoaded($event)"
          >
            <ng-template #emptyFileListRenderTemplate></ng-template>
            <p class="ant-upload-drag-icon">
              <nz-icon nzType="inbox" />
            </p>
            <p class="ant-upload-text">Clique aqui ou arraste uma imagem para carregá-la </p>
          </nz-upload>
          <br>
          <p>ou</p>
          <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" [nzPrefix]="prefixLink">
            <input type="text" nz-input placeholder="Carregue a imagem de uma Url" [(ngModel)]="imgFromUrl" />
          </nz-input-group>
          <ng-template #suffixIconButton>
            <button nz-button  nzSearch (click)="loadImgFromUrl()" [disabled]="!isValidUrl(imgFromUrl)" >
              <nz-icon nzType="cloud-download" /></button>
          </ng-template>
          <ng-template #prefixLink><nz-icon nzType="link" /></ng-template>

        </div>

      </div>

      <div class="steps-content" *ngIf="lastCroppedBlob && currentStep == 1">
        <div class="cropper-wrapper">
          <div style="color: #243164;  width: 100%; text-align: center;">recorte a imagem removendo espaços desnecessários</div>
          <image-cropper
            #imageCropperRef
            [imageChangedEvent]="imageChangedEvent"
            [imageURL]="previewUrl"
            [onlyScaleDown]="true"
            [maintainAspectRatio]="false"
            output="blob"
            format="png"
            (imageCropped)="imageCropped($event)"
            (imageLoaded)="imageLoaded($event)"
            (cropperReady)="cropperReady()"
            (loadImageFailed)="loadImageFailed()"
          ></image-cropper>
        </div>
      </div>

      <div class="steps-action">

        @if (currentStep == 1) {
          <button nz-button nzType="default" (click)="preStep()">
            <span>Voltar</span>
          </button>
          <button nz-button nzType="default" (click)="saveAddImg()">
            <span>Finalizar</span>
          </button>
        }

      </div>

    </ng-container>
  </nz-modal>

  <!-- Modal para exibir o Look com IA -->
  <nz-modal [(nzVisible)]="showAiLookModal"
            nzTitle="Look com IA (Beta)"
            [nzFooter]="null"
            [nzClosable]="true"
            [nzMaskClosable]="true"
            (nzOnCancel)="closeAiLookModal()"
            [nzWidth]="'auto'"
            [nzCentered]="true"
            [nzBodyStyle]="{ height: 'calc(100vh - 80px)', overflow: 'auto', padding: '0' }">
    <ng-container *nzModalContent>
      <!-- Barra superior com controles -->
      <div class="ai-look-controls">
        <div class="control-group">
          <div class="gender-selector">
            <div class="gender-icon woman-icon" 
                 [class.selected]="aiLookGender === 'woman'"
                 (click)="selectGender('woman')"
                 title="Mulher">
            </div>
            <div class="gender-icon man-icon" 
                 [class.selected]="aiLookGender === 'man'"
                 (click)="selectGender('man')"
                 title="Homem">
            </div>
          </div>
        </div>
        
        <div class="control-group">
          <span class="label">Pele</span>
          <div class="color-palette">
            <div class="color-swatch" 
                 [class.selected]="aiLookSkinColor === 'WHITE'"
                 (click)="selectSkinColor('WHITE')"
                 style="background-color: #f1e5dd"></div>
            <div class="color-swatch" 
                 [class.selected]="aiLookSkinColor === 'ASIAN'"
                 (click)="selectSkinColor('ASIAN')"
                 style="background-color: #d7cba5"></div>
            <div class="color-swatch" 
                 [class.selected]="aiLookSkinColor === 'LATIN'"
                 (click)="selectSkinColor('LATIN')"
                 style="background-color: #8d6552"></div>
            <div class="color-swatch" 
                 [class.selected]="aiLookSkinColor === 'BLACK'"
                 (click)="selectSkinColor('BLACK')"
                 style="background-color: #492c22"></div>
          </div>
        </div>

        <div class="control-group">
          <span class="label">Medidas</span>
          <div class="input-group">
            <input type="number" 
                   [(ngModel)]="aiLookWeight" 
                   (ngModelChange)="selectWeight($event)"
                   placeholder="Kg"
                   min="40" max="350">
            <input type="number" 
                   [(ngModel)]="aiLookHeight" 
                   (ngModelChange)="selectHeight($event)"
                   placeholder="Cm"
                   min="60" max="250">
          </div>
        </div>

        <div class="control-actions">
          <button nz-button nzType="primary" (click)="generateFromBar()" [disabled]="loadingAiLook || !aiLookGender || !aiLookSkinColor || !aiLookHeight || !aiLookWeight">
            <nz-icon nzType="sync" [class.spinning]="loadingAiLook"></nz-icon>
            Gerar
          </button>
          <button nz-button nzType="default" (click)="requestAiComment()" [disabled]="!aiLookImage || loadingComment" title="Comentário da IA">
            <nz-icon nzType="message" [class.spinning]="loadingComment"></nz-icon>
          </button>
          <button nz-button nzType="default" (click)="shareHelp()" [disabled]="!aiLookImage" title="Compartilhar">
            <nz-icon nzType="share-alt"></nz-icon>
          </button>
        </div>
      </div>

      <!-- Conteúdo da modal -->
      <div class="ai-look-container" *ngIf="aiLookImage || loadingAiLook">
        <!-- Placeholder fixo enquanto gera, some quando a imagem chega -->
        <div class="ai-look-placeholder" *ngIf="!aiLookImage && loadingAiLook">
          <nz-spin></nz-spin>
        </div>

        <!-- Imagem com overlay de carregamento -->
        <div class="ai-look-image-wrapper" *ngIf="aiLookImage" [class.loading]="loadingAiLook">
          <img [src]="aiLookImage" alt="Look com IA" class="ai-look-image" />
        </div>
      </div>

      <!-- Texto inicial quando não há imagem -->
      <div class="ai-look-initial" *ngIf="!aiLookImage && !loadingAiLook">
        <p>Selecione os parâmetros para gerar o look</p>
      </div>
    </ng-container>
  </nz-modal>

  <!-- Modal para exibir o comentário da IA -->
  <nz-modal [(nzVisible)]="showCommentModal"
            nzTitle="Comentário da IA sobre o Look"
            [nzFooter]="null"
            [nzClosable]="true"
            [nzMaskClosable]="true"
            (nzOnCancel)="closeCommentModal()"
            [nzWidth]="'800px'"
            [nzCentered]="true"
            [nzBodyStyle]="{ maxHeight: 'calc(100vh - 120px)', overflow: 'auto', padding: '0' }">
    <ng-container *nzModalContent>
      <div class="ai-comment-container">
        <div class="ai-comment-content">
          <p [innerHTML]="aiComment"></p>
        </div>
      </div>
    </ng-container>
  </nz-modal>

  <div class="main-container">


    <div class="canvas-column">
      <div class="btn-wrapper show-mobile">
        <button *ngFor="let group of clothingGroups"  
                nz-button 
                (click)="openMobileCategoryModal(group)">
          <img [src]="group.icon" [alt]="group.name" />
        </button>
      </div>
      <div class="canvas-container">
        <canvas #canvas></canvas>
      </div>
      <div class="button-container">
        <label for="import-look" class="button">Importar Look</label>
        <input id="import-look" type="file" accept=".json" (change)="importLook($event)" style="display: none;" />
        <button (click)="saveLook()">Salvar Look</button>
        <button (click)="openAiLookModal()" [disabled]="loadingAiLook">
          <span>Look com IA (Beta)</span>
        </button>
      </div>
    </div>
    <div class="groups-column hidden-mobile">
      <nz-collapse [nzAccordion]="true">
        <nz-collapse-panel *ngFor="let group of clothingGroups" [nzHeader]="group.name">
          <div class="items">
            <div class="add-item" title="Carregar item" (click)="addItem(group)"><nz-icon nzType="plus"></nz-icon> </div>
            <div class="proccess-image" *ngIf="loadingImg" >
              <nz-spin nzTip="aguarde..."></nz-spin>
            </div>
            <div *ngFor="let item of group.items" class="item">
              <div class="image-container">
                <img [src]="item.url" [alt]="item.name" [title]="item.name" class="item-image" (click)="selectClothingItem(group, item)" />
                <nz-rate [(ngModel)]="item.favorited" [nzCount]="1" [nzCharacter]="characterIcon" class="heart-icon"></nz-rate>
              </div>

            </div>
          </div>
        </nz-collapse-panel>
      </nz-collapse>
      <ng-template #characterIcon><nz-icon  nzType="heart" nzTheme="fill" ></nz-icon></ng-template>
    </div>

  </div>
</div>
